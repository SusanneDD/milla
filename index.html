<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Alla hj√§rtans dag</title>
</head>
<body>
    <!-- Bakgrundsmusik -->
    <audio id="background-music" loop>
        <source src="romance.mp3" type="audio/mpeg">
    </audio>
    
    <main class="page">
        <section class="card-stage">
            <div class="card" id="valentine-card">
                <div class="card-face card-front">
                    <img src="milla.jpg" alt="Milla" class="card-image">
                    <div class="front-text">Milla </div>
                    <div class="front-badge">Din Tusse.</div>
                </div>
                <div class="card-face card-inside">
                    <div class="storybook" id="storybook">
                        <div class="scene scene-1">
                            <div class="gentleman"></div>
                            <div class="thought-bubble">
                                <span class="thought-text">Milla</span>
                            </div>
                            <p class="caption">D√§r finns en kvinna...</p>
                        </div>
                        <div class="scene scene-2">
                            <div class="gentleman walk"></div>
                            <p class="caption">...som lyser upp hela min v√§rld.</p>
                        </div>
                        <div class="scene scene-3">
                            <div class="gentleman"></div>
                            <div class="lady"></div>
                            <div class="hearts-float"></div>
                            <p class="caption">Fr√•n f√∂rsta √∂gonblicket visste Tusse: Hon √§r n√•got speciellt.</p>
                        </div>
                        <div class="scene scene-4">
                            <div class="forest-bg"></div>
                            <div class="gentleman picking">
                                <span class="heart-pulse">üñ§</span>
                            </div>
                            <div class="roses-bunch"></div>
                            <p class="caption">Tusse v√§ljer de vackraste rosorna(i sedlar), f√∂r henne.</p>
                        </div>
                        <div class="scene scene-5">
                            <div class="gentleman">
                                <span class="heart-pulse">üñ§</span>
                            </div>
                            <div class="roses-bunch pulse-effect"></div>
                            <div class="lady smile"></div>
                            <div class="hearts-float"></div>
                            <p class="caption">Med rosorna i handen, ger Tusse henne dom.</p>
                        </div>
                        <div class="scene scene-6">
                            <div class="lady hold-roses smile">
                                <span class="heart-pulse">ü©∑</span>
                            </div>
                            <div class="gentleman happy"></div>
                            <div class="hearts-float"></div>
                            <p class="caption">Hon ler och Tusse √§lskar hennes leende √§nnu mer.</p>
                        </div>
                        <div class="scene scene-7">
                            <p class="final-text">Milla min prilla </p>
                            <p class="caption" style="font-size: 0.95rem; margin-bottom: 16px; font-style: italic;">Du f√∂rgyller mina dagar ‚Äî varje dag med dig √§r som Alla hj√§rtans dag.</p>
                            <p class="final-sign">Din TUSSE.üñ§</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="controls">
                <button class="control" id="card-close" aria-label="St√§ng kort">‚úï</button>
                <button class="control" id="prev-scene" aria-label="F√∂reg√•ende scen">‚Üê</button>
                <button class="control" id="next-scene" aria-label="N√§sta scen">‚Üí</button>
                <button class="control music-toggle" id="music-toggle" aria-label="Sl√• p√•/av musik">üîä</button>
            </div>
            <p class="hint">Tryck p√• ‚Üí f√∂r att √∂ppna kortet. Anv√§nd pilarna f√∂r att bl√§ddra.</p>
        </section>
    </main>
    <script>
        const card = document.getElementById("valentine-card");
        const storybook = document.getElementById("storybook");
        const music = document.getElementById("background-music");
        const musicToggle = document.getElementById("music-toggle");
        let musicPlaying = false;
        let currentScene = 0;
        let isNavigating = false;
        let autoPlayTimeout = null;
        let isManualMode = false;
        
        const scenes = [1, 2, 3, 4, 5, 6, 7];
        
        function navigateToScene(sceneNumber) {
            if (isNavigating || !card.classList.contains("open")) return;
            
            isNavigating = true;
            isManualMode = true;
            currentScene = Math.min(Math.max(sceneNumber, 0), scenes.length - 1);
            
            // Stop all automatic animations
            const allScenes = document.querySelectorAll(".scene");
            allScenes.forEach((scene) => {
                scene.style.animation = "none";
                scene.style.transition = "all 0.6s ease";
            });
            
            // Hide all scenes and show current one
            allScenes.forEach((scene, index) => {
                if (index === currentScene) {
                    scene.style.opacity = "1";
                    scene.style.transform = "scale(1)";
                    scene.style.pointerEvents = "auto";
                } else {
                    scene.style.opacity = "0";
                    scene.style.transform = "scale(0.95)";
                    scene.style.pointerEvents = "none";
                }
            });
            
            setTimeout(() => {
                isNavigating = false;
            }, 600);
        }
        
        // Handle next scene button (right arrow)
        document.getElementById("next-scene")?.addEventListener("click", () => {
            if (!card.classList.contains("open")) {
                // Open card and start automatic playback
                card?.classList.add("open");
                currentScene = 0;
                isNavigating = false;
                isManualMode = false;
                
                // Start music when card opens (first time only)
                if (!musicPlaying) {
                    music.currentTime = 0;
                    music.play().catch(err => console.log("Play failed:", err));
                    musicPlaying = true;
                    musicToggle.textContent = "üîä";
                    musicToggle.classList.remove("muted");
                }
                
                // Reset all scenes - let CSS animations play automatically
                const allScenes = document.querySelectorAll(".scene");
                allScenes.forEach((scene) => {
                    scene.style.animation = "";
                    scene.style.opacity = "";
                    scene.style.transform = "";
                    scene.style.transition = "";
                    scene.style.pointerEvents = "";
                });
                
                // Auto-close card after animation completes (45s + buffer)
                if (autoPlayTimeout) clearTimeout(autoPlayTimeout);
                autoPlayTimeout = setTimeout(() => {
                    if (!isManualMode) {
                        card?.classList.remove("open");
                    }
                }, 46000);
            } else if (!isManualMode) {
                // Switch to manual mode when user clicks arrow during automatic playback
                navigateToScene(Math.min(currentScene + 1, scenes.length - 1));
            } else {
                // Already in manual mode - navigate to next scene
                if (currentScene < scenes.length - 1) {
                    navigateToScene(currentScene + 1);
                }
            }
        });
        
        // Handle previous scene button (left arrow)
        document.getElementById("prev-scene")?.addEventListener("click", () => {
            if (!card.classList.contains("open")) {
                return; // Do nothing if card is closed
            }
            
            if (!isManualMode) {
                // Switch to manual mode when user clicks arrow during automatic playback
                navigateToScene(Math.max(currentScene - 1, 0));
            } else {
                // Already in manual mode - navigate to previous scene
                if (currentScene > 0) {
                    navigateToScene(currentScene - 1);
                }
            }
        });
        
        // Handle close button (X button)
        document.getElementById("card-close")?.addEventListener("click", () => {
            // Always close card when X is clicked
            card?.classList.remove("open");
            if (autoPlayTimeout) clearTimeout(autoPlayTimeout);
            isManualMode = false;
            
            // Reset all scene styles when closing
            const allScenes = document.querySelectorAll(".scene");
            allScenes.forEach((scene) => {
                scene.style.animation = "";
                scene.style.opacity = "";
                scene.style.transform = "";
                scene.style.transition = "";
                scene.style.pointerEvents = "";
            });
        });
        
        // Music toggle
        musicToggle?.addEventListener("click", (e) => {
            e.stopPropagation();
            if (music.paused) {
                music.currentTime = 0;
                const playPromise = music.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        musicToggle.textContent = "üîä";
                        musicToggle.classList.remove("muted");
                        musicPlaying = true;
                    }).catch(err => console.log("Play failed:", err));
                }
            } else {
                music.pause();
                musicToggle.textContent = "üîá";
                musicToggle.classList.add("muted");
                musicPlaying = false;
            }
        });
    </script>
</body>
</html>